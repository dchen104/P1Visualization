<html>
<head>
    <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <title>Amazon Reviews Visualizations</title>
    <style>
        .axis path { fill: none; stroke: black;}
        .axis line { stroke: black; }
        circle {
            fill: #000066;
        }
        input[type=range] {

            width: 500px;
        }
        .min, .max {
            position: absolute;
        }
        .max {
            top: 10px;
            left: 500px;
        }
        .min {
            top:10px;
        }
        #sliderDiv {
            height: 70px;
            position: relative;
        }
    </style>
</head>

<body>
<div id = "canvas"></div>

<script>
    //Scale values and bounds for our scales are simply placeholders at the moment, will expand upon them soon, when we know what data
    //we're working with.
    
    //Axis scales
    var xAxScale = d3.scale.linear().domain([2012.75, 2014.3]).range([100, 900]);
    var yAxScale = d3.scale.linear().domain([1, 5]).range([900, 50]);
    //The x-axis scale for the PS4 and the Xbox One.
    var xAxScalePS4 = d3.scale.linear().domain([2013.75, 2014.3]).range([100, 900]);

   //Canvas svg elements creation
    var svg = d3.select("#canvas")
        .append("svg")
        .attr("height", 1000)
        .attr("width", 1000);

    var svg2 = d3.select("#canvas")
        .append("svg")
        .attr("height", 1000)
        .attr("width", 1000);

    var svg3 = d3.select("#canvas")
        .append("svg")
        .attr("height", 1000)
        .attr("width", 1000);

   
    //Generate axes.
    var xAxis = d3.svg.axis().scale(xAxScale).tickFormat(d3.format("d"));
    var xAxis2 = d3.svg.axis().scale(xAxScalePS4).tickFormat(d3.format("d"));

    var yAxis = d3.svg.axis().scale(yAxScale).orient("left").ticks(5);
    
    var avgReviews = {};

    var file = "wii.json";
    //Checks if asynchronous call to json data is finished.
    var isFinished = false;


    //concatenates month and year together to form a string of the first day of that month for that year
    var parseDate = function (month, year){
        var temp = month;
        temp += " 1, ";
        temp += year;
        return temp;
        }

    var keys = new Array();
    var keyCount = 0;

    d3.json(file, function (data){
        var sum = 0.0;
        var num = 0;
        var date = "";
        var temp;
        json = data;
        for(var i = 0; i < json.reviews.length; i++){
        var review = json.reviews[i];
        date = parseDate(review.month, review.year);
        if(!avgReviews[date]){
        avgReviews[date] = {"date" : date, "avg": review.rating, "num": 1};
        keys[keyCount++] = date;
        }
        else{
        temp = avgReviews[date];
        temp.avg += review.rating;
        temp.num++;
        }
        }
        for(var i = 0; i < keyCount; i++){
        var key = keys[i];
        var temp = avgReviews[key];
        var avg = (temp.avg / temp.num);
        avgReviews[key].avg = avg;
        }
        isFinished = true;
    });



    //Path data used to calculate the line path through the circles
    var pathArrData = [];

    //Appends the axes to all the graph.
    svg.append("g")
        .attr("class", "axis")
        .attr("transform", "translate(0, 900)")
        .call(xAxis);

    svg.append("g")
        .attr("class", "axis")
        .attr("transform", "translate(100, 0)")
        .call(yAxis);


    svg2.append("g")
        .attr("class", "axis")
        .attr("transform", "translate(0, 900)")
        .call(xAxis2);

    svg2.append("g")
        .attr("class", "axis")
        .attr("transform", "translate(100, 0)")
        .call(yAxis);


    svg3.append("g")
        .attr("class", "axis")
        .attr("transform", "translate(0, 900)")
        .call(xAxis2);

    svg3.append("g")
        .attr("class", "axis")
        .attr("transform", "translate(100, 0)")
        .call(yAxis);

    //Generate lables and title.
    generateLabels(svg);
    generateLabels(svg2);
    generateLabels(svg3);


    //Add filter slider for filtering out circles by helpfulness percentage
    var sliderDiv = d3.select("#canvas")
        .append("div")
        .attr("id", "sliderDiv");

    sliderDiv
        .append("label")
        .attr("for", "slider")
        .html('<span class = "min">0%</span><span class = "max">100%</span>');

    var slider = sliderDiv
        .append("input")
        .attr("type", "range")
        .attr("min", "0")
        .attr("max", "100")
        .attr("value", "0")
        .attr("id", "slider");
        
    //Generates the interactivity for the slider
    //sliderHelpful(slider);

    //Scales to be used for circle locations and information, scaleName corresponds to what scale in the visualization
    //it will be used for.
    var dateScale = d3.scale.linear().domain([Date.parse("September 1, 2012"), Date.parse("March 31, 2014")]).range([100, 900]);
    var starScale = d3.scale.linear().domain([1, 5]).range([850, 50]);
    var numReviewScale = d3.scale.linear().domain([0, 100]).range([10, 25]);
    var dateScale2 = d3.scale.linear().domain([Date.parse("September 1, 2013"), Date.parse("March 31, 2014")]).range([100, 900]);
   // var helpfulScale = d3.scale.linear().domain([0, 1]).range([25, 100]);



    while(!isFinished) {
    
    }
    createCircles(dateScale);

    //Calls function to draw line through all circles. 
    appendLine(); 

    //Generates the circles average review data
    function createCircles(dScale) {
        for(i = 0; i < keyCount; i++) {
            var key = keys[i];
            var obj = avgReviews[key];
            appendNewCircle(obj.date, obj.avg, obj.num, dScale );
        }

    }

    //Function called everytime we append a new circle by parsing our data.
    function appendNewCircle(date, star, numberReviews, dScale) {
        //The calculated color of the circle based on its average star rating field.
        var color = colorScale(star);
        //Appends new circle to graph.
        var circle = svg.append("circle")
            .attr("cx", dScale(Date.parse(date)))
            .attr("cy", starScale(star))
            .attr("r", numReviewScale(numberReviews))
            //.style("fill-opacity", helpful);
            .style("fill", color);

        pathArrData.push({"x": dateScale(Date.parse(date)), "y": starScale(star)});


        //Deals with how clicking on a circle will display its written review.
        /*circle.on("click", function() {
            var width = screen.availWidth/2;
            var height = screen.availHeight/2;
            var written = ("<h1 class = reviewHeader>Review</h1><p>" + review + "</p>");
            var style = ("<style> html {background-color: #0099CC} .reviewHeader {text-align: center} </style>");
            var newWindow = window.open("","", "width=" + width, "height=" + height); newWindow.document.write("<html><head>" + style + "</head><body>" + written + "</body>");


            }); */
    }

    //Following code appends a path to the svg that traverses through all the circles.
    function appendLine() {
        
        //Sorts the path data array so the path line is drawn correctly.
        pathArrData.sort(function(a, b) {
            if(a.x < b.x) {

                return -1;
            }

            else if(a.x > b.x) {
                return 1;
            }
            else {
                return 0;
            }
        });
        var line = d3.svg.line()
                       .x(function(d) {return d.x;})
                       .y(function(d) {return d.y;});
        var linePath = svg.append("path")
                            .attr("d", line(pathArrData))
                            .attr("stroke", "black")
                            .attr("stroke-width", 1)
                            .attr("fill", "none");

    }


	//Function to map value of average review to a color from red (lowest) to green (highest)
	function colorScale(star){
	    //a rating of 3 corresponds to yellow
	    if (star==3) {
		return "rgb(255, 255, 0)";
	    }
	    //ratings greater than 3 are mapped between yellow and green
	    else if (star>3) {
		var scale = d3.scale.linear().domain([5,3]).range([0,255]);
		return "rgb("+Math.floor(scale(star))+",255, 0)";
	    }
	    //ratings below 3 are mapped between yellow and red
	    else{
		var scale = d3.scale.linear().domain([1,3]).range([0,255]);
		return "rgb(255," + Math.floor(scale(star)) + ", 0)";
	    }
	};

    //Function generates labels and titles for graph
    function generateLabels(svgEl) {
        svgEl.append("text")
            .attr("x", xAxScale(2013.5))
            .attr("y", yAxScale(5.05))
            .attr("text-anchor", "middle")
            .attr("font-size", "16px")
            .attr("text-decoration", "underline")
            .text("Amazon Console Reviews Over Time");

        svgEl.append("text")
            .attr("x", xAxScale(2013.5))
            .attr("y", yAxScale(0.75))
            .attr("text-anchor", "middle")
            .attr("font-size", "12px")
            .attr("font-weight", "bold")
            .text("Date");

        svgEl.append("text")
            .attr("x", xAxScale(2012.5))
            .attr("y", yAxScale(3))
            .attr("text-anchor", "middle")
            .attr("font-size", "12px")
            .attr("font-weight", "bold")
            .attr("transform", "rotate(-90, " + xAxScale(2012.5) + ", " + yAxScale(3))
            .text("Average star rating");
    }

    //Generates the interactivity for the slider. All circles with less than the slider value of helpfulness
    //percentage will be hidden.
    function sliderHelpful(slider) {
        slider.on("change", function() {
            //Value of the slider
            var slideVal = this.value / 100;
            d3.selectAll("circle")
                .each(function(d, i) {

                if(d < slideVal) {
                    d3.select(this)
                        .style("visibility", "hidden");
                }
                else {
                    d3.select(this)
                        .style("visibility", "visible");
                }
                });
        });
    



    }
</script>

    

</body>

</html>
